---
- hosts:
    - common_openshift_sys-dev1
  gather_facts: no
  tasks:
    - lineinfile:
        path: /etc/sysconfig/docker
        regexp: ^((?!#).*--block-registry[\s=]+docker\.io.*)$
        line: '#\1'
        backrefs: yes
      register: unblocked
    - service:
        name: docker
        state: restarted
      when: unblocked.changed

- hosts:
    - common_openshift_sys-dev1
  gather_facts: no
  # We don't think it's necessary to do this in serial, or wait between nodes
  # but since we're not sure we'll go with one out of two.
  serial: 1
  tasks:
    - service:
        name: docker
        state: restarted
  tags:
    - restart-docker

- hosts:
    - common_openshift_sys-dev1_app
  gather_facts: no
  # We don't think it's necessary to do this in serial, or wait between nodes
  # but since we're not sure we'll go with one out of two.
  serial: 1
  vars:
    master_node: common-sys-dev1-master-1.ris.wustl.edu
  tasks:
    - name: make node unschedulable
      shell: |
        oc adm manage-node {{ inventory_hostname }} --schedulable=false
      delegate_to: "{{ master_node }}"
      register: unschedule
    - name: drain pods
      shell: |
        oc adm drain {{ inventory_hostname }} --ignore-daemonsets --delete-local-data
      delegate_to: "{{ master_node }}"
      register: drain
    - name: restart docker "manually"
      shell: |
        systemctl restart docker
      register: docker_restart
    - name: make node schedulable again
      shell: |
        oc adm manage-node {{ inventory_hostname }} --schedulable=true
      delegate_to: "{{ master_node }}"
      register: reschedule
    - debug:
        var: "{{ item }}"
      loop:
        - unschedule
        - drain
        - docker_restart
        - reschedule
  tags:
    - restart-docker-by-hand
