---
- hosts:
    - common_openshift
  gather_facts: no
  tasks:
    - shell: puppet config print agent_disabled_lockfile | awk '{ print $NF }'
      register: puppet_lockfile
      check_mode: no
      changed_when: false
    - copy:
        dest: "{{ puppet_lockfile.stdout_lines.0 | trim }}"
        content: '{"disabled_message":"ITDEV-10824"}'
    - service:
        name: process-exporter
        state: stopped
      tags:
        - disable-prometheus
    - service:
        name: node_exporter
        state: stopped
      tags:
        - disable-prometheus
    - name: '*DISABLE* services as well'
      shell: systemctl disable {{ item }}
      loop:
        - puppet
        - node_exporter
        - process-exporter

- hosts:
    - common_openshift
  gather_facts: no
  tags:
    - disable-cron
  tasks:
    - cron:
        name: disable puppet's node-exporter job
        job: /bin/bash -lc -- /usr/local/bin/prometheus-ntpq-check 1>/dev/null 2>/dev/null
        user: node-exporter
        disabled: yes
    - cron:
        name: disable puppet's sshd job
        job: renice -n 0 -p `pidof sshd` >/dev/null 2>&1
        disabled: yes
